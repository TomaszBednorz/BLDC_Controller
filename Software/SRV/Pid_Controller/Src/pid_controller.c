/***********************************************************************************************************
 ********************************************* Included files **********************************************
 ***********************************************************************************************************/

#include "pid_controller.h"

/***********************************************************************************************************
 ************************************************* Defines *************************************************
 ***********************************************************************************************************/

/***********************************************************************************************************
 *********************************************** Data types ************************************************
 ***********************************************************************************************************/

/***********************************************************************************************************
 **************************************** Local function prototypes ****************************************
 ***********************************************************************************************************/

/***********************************************************************************************************
 ******************************************** Exported objects *********************************************
 ***********************************************************************************************************/

/***********************************************************************************************************
 ********************************************* Local objects ***********************************************
 ***********************************************************************************************************/

/***********************************************************************************************************
 ******************************************* Exported functions ********************************************
 ***********************************************************************************************************/

void Pid_Controller_Init(Pid_Controller_Data_t* pid, float kp_init, float ki_init, float kd_init, float anti_windup_limit_init)
{
	pid->previous_error = 0.0f;
	pid->total_error = 0.0f;
	pid->Kp = kp_init;
	pid->Ki = ki_init;
	pid->Kd = kd_init;
	pid->anti_windup_limit = anti_windup_limit_init;
}

void Pid_Controller_Reset(Pid_Controller_Data_t* pid)
{
	pid->total_error = 0.0f;
	pid->previous_error = 0.0f;
}

float Pid_Controller_Calculate(Pid_Controller_Data_t* pid, float setpoint, float current_value)
{
	float error;
	float p_term, i_term, d_term;

	error = setpoint - current_value;

	pid->total_error += error;

	if(pid->total_error >= pid->anti_windup_limit)
	{
		pid->total_error = pid->anti_windup_limit;
	}
	else if(pid->total_error <= -pid->anti_windup_limit) 
	{
		pid->total_error = -pid->anti_windup_limit;
	}

	p_term = (float)(pid->Kp * error);
	i_term = (float)(pid->Ki * pid->total_error);
	d_term = (float)(pid->Kd * (error - pid->previous_error));

	pid->previous_error = error;

	return (p_term + i_term + d_term);
}

/***********************************************************************************************************
 ******************************************** Local functions **********************************************
 ***********************************************************************************************************/
