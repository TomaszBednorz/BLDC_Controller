/***********************************************************************************************************
 ********************************************* Included files **********************************************
 ***********************************************************************************************************/

#include "app_motor_cfg.h"
#include "app_motor.h"
#include "app_hall.h"
#include "app_6step.h"
#include "app_pid.h"
#include "app_counter.h"
#include "hal_tim.h"
#include "hal_adc.h"
#include "app_enc.h"
#include "DIGITAL_IO/digital_io.h"

/***********************************************************************************************************
 ************************************************* Defines *************************************************
 ***********************************************************************************************************/

#define APP_MOTOR_BEMF_U_PHASE    (HAL_ADC_BEMF_A_IDX)
#define APP_MOTOR_BEMF_V_PHASE    (HAL_ADC_BEMF_B_IDX)
#define APP_MOTOR_BEMF_W_PHASE    (HAL_ADC_BEMF_C_IDX)
#define APP_MOTOR_BEMF_NEUTR_P    (HAL_ADC_BEMF_N_P_IDX)
#define APP_MOTOR_BEMF_NBR        (HAL_ADC_BEMF_IDX_MAX)

#define APP_MOTOR_DIV_BY_8        (3U)
#define APP_MOTOR_DIV_BY_2        (1U)

#define APP_MOTOR_BEMF_FIFO_MAX  (3U)

#define App_Motor_CalculateAvg(a, b, c)     ((a + b + c) / 3)

#define APP_MOTOR_CURR_U_PHASE    (HAL_ADC_CURR_SENSE_OUT1_IDX)
#define APP_MOTOR_CURR_V_PHASE    (HAL_ADC_CURR_SENSE_OUT2_IDX)
#define APP_MOTOR_CURR_W_PHASE    (HAL_ADC_CURR_SENSE_OUT3_IDX)
#define APP_MOTOR_CURR_NBR        (HAL_ADC_CURR_SENSE_IDX_MAX)

/***********************************************************************************************************
 *********************************************** Data types ************************************************
 ***********************************************************************************************************/

/* @APP_MOTOR_MOTOR_STATE */
typedef enum
{
    APP_MOTOR_MOTOR_ALIGNMENT = 0,
    APP_MOTOR_MOTOR_START = 1,
    APP_MOTOR_MOTOR_RUN = 2,
    APP_MOTOR_MOTOR_STOP = 3
}App_Motor_MotorState_t;

/* @APP_MOTOR_STATE */
typedef enum
{
    APP_MOTOR_BLDC_DISABLED = 0,
    APP_MOTOR_BLDC_ENABLED = 1
}App_Motor_State_t;

typedef struct 
{
    App_Motor_MotorState_t motor_state;                     /* @APP_MOTOR_MOTOR_STATE */
    App_Pid_Controller_t pid_speed;
    App_Pid_Controller_t pid_position;
    volatile uint8_t step_updated_flag;
    App_Motor_State_t current_state;                        /* @APP_MOTOR_STATE */
    App_Pid_Controller_t pid_current;
    App_Motor_State_t bldc_state;                           /* @APP_MOTOR_STATE */
    volatile uint16_t bemf_fifo[APP_MOTOR_BEMF_FIFO_MAX];
    volatile uint8_t bemf_cnt;
}App_Motor_Setup_t;

/***********************************************************************************************************
 **************************************** Local function prototypes ****************************************
 ***********************************************************************************************************/

static void App_Motor_StateAlignment(void);
static void App_Motor_StateStart(void);
static void App_Motor_BemfAnalysis(void);
static void App_Motor_CurrentAnalysis(void);
static void App_Motor_ZeroCrossingPointDetected(void);
static bool App_Motor_AddBemfToFifo(uint16_t fifo_in, uint16_t* filtered_out);
static void App_Motor_SetSpeed(float deg_s);
static float App_Motor_GetSpeed(void);

/***********************************************************************************************************
 ******************************************** Exported objects *********************************************
 ***********************************************************************************************************/

/***********************************************************************************************************
 ********************************************* Local objects ***********************************************
 ***********************************************************************************************************/

static App_Motor_Setup_t App_Motor_Setup;

static float App_Motor_SpeedSetpoint;
static float App_Motor_PositionSetpoint;

static float App_Motor_CurrentSpeed;

/***********************************************************************************************************
 ******************************************* Exported functions ********************************************
 ***********************************************************************************************************/

void App_Motor_Init(void)
{
    App_Pid_Init(&App_Motor_Setup.pid_speed, 
                 APP_MOTOR_SPEED_PID_P_TERM, 
                 APP_MOTOR_SPEED_PID_I_TERM, 
                 APP_MOTOR_SPEED_PID_D_TERM, 
                 APP_MOTOR_SPEED_PID_ANTI_WINDUP_LIMIT);
    App_Pid_Init(&App_Motor_Setup.pid_current, 
                 APP_MOTOR_CURRENT_PID_P_TERM, 
                 APP_MOTOR_CURRENT_PID_I_TERM, 
                 APP_MOTOR_CURRENT_PID_D_TERM, 
                 APP_MOTOR_CURRENT_PID_ANTI_WINDUP_LIMIT);
    App_Pid_Init(&App_Motor_Setup.pid_position, 
                 APP_MOTOR_POSITION_PID_P_TERM, 
                 APP_MOTOR_POSITION_PID_I_TERM, 
                 APP_MOTOR_POSITION_PID_D_TERM, 
                 APP_MOTOR_POSITION_PID_ANTI_WINDUP_LIMIT);
    App_Motor_Setup.step_updated_flag = 0U;
    App_Motor_Setup.motor_state = APP_MOTOR_MOTOR_ALIGNMENT;
    App_Motor_Setup.bldc_state = APP_MOTOR_BLDC_DISABLED;
    App_Motor_Setup.current_state = APP_MOTOR_BLDC_DISABLED;
    App_Motor_Setup.bemf_cnt = 0U;
}

char buffer[50];
#include "UART/uart.h"
#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include "DIGITAL_IO/digital_io.h"
#include "app_6step.h"

// static const float sinLUT[2000] = {
//     0.00, 0.63, 1.26, 1.89, 2.51, 3.14, 3.77, 4.40, 5.03, 5.65, 6.28, 6.91, 7.54, 8.16, 8.79, 9.42, 10.04, 10.67, 11.29, 11.92, 12.54, 13.16, 13.79, 14.41, 15.03, 15.65, 16.27, 16.89, 17.51, 18.13, 18.75, 19.36, 19.98, 20.60, 21.21, 21.83, 22.44, 23.05, 23.66, 24.27, 24.88, 25.49, 26.10, 26.70, 27.31, 27.91, 28.52, 29.12, 29.72, 30.32, 30.92, 31.51, 32.11, 32.70, 33.30, 33.89, 34.48, 35.07, 35.66, 36.24, 36.83, 37.41, 38.00, 38.58, 39.16, 39.73, 40.31, 40.88, 41.46, 42.03, 42.60, 43.17, 43.73, 44.30, 44.86, 45.42, 45.98, 46.54, 47.09, 47.65, 48.20, 48.75, 49.30, 49.84, 50.39, 50.93, 51.47, 52.01, 52.54, 53.07, 53.61, 54.14, 54.66, 55.19, 55.71, 56.23, 56.75, 57.27, 57.78, 58.29, 58.80, 59.31, 59.82, 60.32, 60.82, 61.32, 61.81, 62.31, 62.80, 63.28, 63.77, 64.25, 64.73, 65.21, 65.69, 66.16, 66.63, 67.10, 67.56, 68.02, 68.48, 68.94, 69.39, 69.84, 70.29, 70.74, 71.18, 71.62, 72.06, 72.49, 72.92, 73.35, 73.78, 74.20, 74.62, 75.04, 75.45, 75.86, 76.27, 76.68, 77.08, 77.48, 77.87, 78.27, 78.66, 79.04, 79.43, 79.81, 80.18, 80.56, 80.93, 81.30, 81.66, 82.02, 82.38, 82.74, 83.09, 83.44, 83.78, 84.12, 84.46, 84.79, 85.13, 85.45, 85.78, 86.10, 86.42, 86.73, 87.04, 87.35, 87.66, 87.96, 88.25, 88.55, 88.84, 89.13, 89.41, 89.69, 89.96, 90.24, 90.51, 90.77, 91.03, 91.29, 91.55, 91.80, 92.05, 92.29, 92.53, 92.77, 93.00, 93.23, 93.45, 93.68, 93.89, 94.11, 94.32, 94.53, 94.73, 94.93, 95.13, 95.32, 95.51, 95.69, 95.87, 96.05, 96.22, 96.39, 96.56, 96.72, 96.87, 97.03, 97.18, 97.33, 97.47, 97.61, 97.74, 97.87, 98.00, 98.12, 98.24, 98.36, 98.47, 98.58, 98.68, 98.78, 98.88, 98.97, 99.06, 99.14, 99.22, 99.30, 99.37, 99.44, 99.50, 99.56, 99.62, 99.67, 99.72, 99.77, 99.81, 99.84, 99.88, 99.91, 99.93, 99.95, 99.97, 99.98, 99.99, 100.00, 100.00, 100.00, 99.99, 99.98, 99.97, 99.95, 99.93, 99.90, 99.87, 99.84, 99.80, 99.76, 99.71, 99.66, 99.61, 99.55, 99.49, 99.42, 99.35, 99.28, 99.20, 99.12, 99.03, 98.95, 98.85, 98.76, 98.65, 98.55, 98.44, 98.33, 98.21, 98.09, 97.97, 97.84, 97.71, 97.57, 97.43, 97.29, 97.14, 96.99, 96.84, 96.68, 96.51, 96.35, 96.18, 96.00, 95.83, 95.64, 95.46, 95.27, 95.08, 94.88, 94.68, 94.48, 94.27, 94.06, 93.84, 93.62, 93.40, 93.17, 92.94, 92.71, 92.47, 92.23, 91.98, 91.74, 91.48, 91.23, 90.97, 90.71, 90.44, 90.17, 89.90, 89.62, 89.34, 89.05, 88.77, 88.48, 88.18, 87.88, 87.58, 87.28, 86.97, 86.65, 86.34, 86.02, 85.70, 85.37, 85.04, 84.71, 84.38, 84.04, 83.69, 83.35, 83.00, 82.65, 82.29, 81.93, 81.57, 81.21, 80.84, 80.47, 80.09, 79.71, 79.33, 78.95, 78.56, 78.17, 77.78, 77.38, 76.98, 76.58, 76.17, 75.76, 75.35, 74.94, 74.52, 74.10, 73.67, 73.25, 72.82, 72.38, 71.95, 71.51, 71.07, 70.63, 70.18, 69.73, 69.28, 68.83, 68.37, 67.91, 67.44, 66.98, 66.51, 66.04, 65.57, 65.09, 64.61, 64.13, 63.65, 63.16, 62.67, 62.18, 61.69, 61.19, 60.69, 60.19, 59.69, 59.18, 58.68, 58.17, 57.65, 57.14, 56.62, 56.10, 55.58, 55.06, 54.53, 54.00, 53.47, 52.94, 52.41, 51.87, 51.33, 50.79, 50.25, 49.70, 49.16, 48.61, 48.06, 47.51, 46.95, 46.40, 45.84, 45.28, 44.72, 44.16, 43.59, 43.02, 42.46, 41.89, 41.31, 40.74, 40.17, 39.59, 39.01, 38.43, 37.85, 37.27, 36.68, 36.10, 35.51, 34.92, 34.33, 33.74, 33.15, 32.56, 31.96, 31.36, 30.77, 30.17, 29.57, 28.97, 28.37, 27.76, 27.16, 26.55, 25.95, 25.34, 24.73, 24.12, 23.51, 22.90, 22.28, 21.67, 21.06, 20.44, 19.83, 19.21, 18.59, 17.97, 17.36, 16.74, 16.12, 15.50, 14.87, 14.25, 13.63, 13.01, 12.38, 11.76, 11.14, 10.51, 9.88, 9.26, 8.63, 8.01, 7.38, 6.75, 6.13, 5.50, 4.87, 4.24, 3.61, 2.99, 2.36, 1.73, 1.10, 0.47, -0.16, -0.79, -1.41, -2.04, -2.67, -3.30, -3.93, -4.56, -5.18, -5.81, -6.44, -7.07, -7.69, -8.32, -8.95, -9.57, -10.20, -10.82, -11.45, -12.07, -12.70, -13.32, -13.94, -14.56, -15.19, -15.81, -16.43, -17.05, -17.67, -18.28, -18.90, -19.52, -20.13, -20.75, -21.36, -21.98, -22.59, -23.20, -23.81, -24.42, -25.03, -25.64, -26.25, -26.85, -27.46, -28.06, -28.67, -29.27, -29.87, -30.47, -31.07, -31.66, -32.26, -32.85, -33.45, -34.04, -34.63, -35.22, -35.81, -36.39, -36.98, -37.56, -38.14, -38.72, -39.30, -39.88, -40.45, -41.03, -41.60, -42.17, -42.74, -43.31, -43.87, -44.44, -45.00, -45.56, -46.12, -46.68, -47.23, -47.78, -48.34, -48.88, -49.43, -49.98, -50.52, -51.06, -51.60, -52.14, -52.67, -53.21, -53.74, -54.27, -54.80, -55.32, -55.84, -56.36, -56.88, -57.40, -57.91, -58.42, -58.93, -59.44, -59.94, -60.44, -60.94, -61.44, -61.94, -62.43, -62.92, -63.41, -63.89, -64.37, -64.85, -65.33, -65.80, -66.28, -66.75, -67.21, -67.68, -68.14, -68.60, -69.05, -69.51, -69.96, -70.40, -70.85, -71.29, -71.73, -72.17, -72.60, -73.03, -73.46, -73.89, -74.31, -74.73, -75.14, -75.56, -75.97, -76.37, -76.78, -77.18, -77.58, -77.97, -78.36, -78.75, -79.14, -79.52, -79.90, -80.28, -80.65, -81.02, -81.39, -81.75, -82.11, -82.47, -82.82, -83.17, -83.52, -83.87, -84.21, -84.54, -84.88, -85.21, -85.54, -85.86, -86.18, -86.50, -86.81, -87.12, -87.43, -87.73, -88.03, -88.33, -88.62, -88.91, -89.20, -89.48, -89.76, -90.03, -90.31, -90.57, -90.84, -91.10, -91.36, -91.61, -91.86, -92.11, -92.35, -92.59, -92.83, -93.06, -93.29, -93.51, -93.73, -93.95, -94.16, -94.37, -94.58, -94.78, -94.98, -95.17, -95.36, -95.55, -95.74, -95.92, -96.09, -96.26, -96.43, -96.60, -96.76, -96.91, -97.07, -97.22, -97.36, -97.50, -97.64, -97.77, -97.90, -98.03, -98.15, -98.27, -98.39, -98.50, -98.60, -98.71, -98.80, -98.90, -98.99, -99.08, -99.16, -99.24, -99.32, -99.39, -99.45, -99.52, -99.58, -99.63, -99.69, -99.73, -99.78, -99.82, -99.85, -99.89, -99.91, -99.94, -99.96, -99.97, -99.99, -99.99, -100.00, -100.00, -100.00, -99.99, -99.98, -99.96, -99.94, -99.92, -99.89, -99.86, -99.83, -99.79, -99.74, -99.70, -99.65, -99.59, -99.53, -99.47, -99.40, -99.33, -99.26, -99.18, -99.10, -99.01, -98.92, -98.83, -98.73, -98.63, -98.52, -98.41, -98.30, -98.18, -98.06, -97.94, -97.81, -97.67, -97.54, -97.40, -97.25, -97.10, -96.95, -96.80, -96.64, -96.47, -96.31, -96.13, -95.96, -95.78, -95.60, -95.41, -95.22, -95.03, -94.83, -94.63, -94.42, -94.21, -94.00, -93.79, -93.57, -93.34, -93.11, -92.88, -92.65, -92.41, -92.17, -91.92, -91.67, -91.42, -91.16, -90.90, -90.64, -90.37, -90.10, -89.83, -89.55, -89.27, -88.98, -88.69, -88.40, -88.11, -87.81, -87.50, -87.20, -86.89, -86.58, -86.26, -85.94, -85.62, -85.29, -84.96, -84.63, -84.29, -83.95, -83.61, -83.26, -82.91, -82.56, -82.20, -81.84, -81.48, -81.11, -80.74, -80.37, -80.00, -79.62, -79.24, -78.85, -78.46, -78.07, -77.68, -77.28, -76.88, -76.48, -76.07, -75.66, -75.25, -74.83, -74.41, -73.99, -73.57, -73.14, -72.71, -72.28, -71.84, -71.40, -70.96, -70.52, -70.07, -69.62, -69.17, -68.71, -68.25, -67.79, -67.33, -66.86, -66.39, -65.92, -65.45, -64.97, -64.49, -64.01, -63.53, -63.04, -62.55, -62.06, -61.56, -61.07, -60.57, -60.07, -59.56, -59.06, -58.55, -58.04, -57.53, -57.01, -56.49, -55.97, -55.45, -54.93, -54.40, -53.87, -53.34, -52.81, -52.27, -51.74, -51.20, -50.66, -50.11, -49.57, -49.02, -48.47, -47.92, -47.37, -46.81, -46.26, -45.70, -45.14, -44.58, -44.01, -43.45, -42.88, -42.31, -41.74, -41.17, -40.60, -40.02, -39.44, -38.87, -38.29, -37.71, -37.12, -36.54, -35.95, -35.36, -34.78, -34.19, -33.59, -33.00, -32.41, -31.81, -31.22, -30.62, -30.02, -29.42, -28.82, -28.21, -27.61, -27.01, -26.40, -25.79, -25.19, -24.58, -23.97, -23.36, -22.74, -22.13, -21.52, -20.90, -20.29, -19.67, -19.06, -18.44, -17.82, -17.20, -16.58, -15.96, -15.34, -14.72, -14.10, -13.47, -12.85, -12.23, -11.60, -10.98, -10.35, -9.73, -9.10, -8.48, -7.85, -7.22, -6.60, -5.97, -5.34, -4.71, -4.08, -3.46, -2.83, -2.20, -1.57, -0.94, -0.31, 0.31, 0.94, 1.57, 2.20, 2.83, 3.46, 4.08, 4.71, 5.34, 5.97, 6.60, 7.22, 7.85, 8.48, 9.10, 9.73, 10.35, 10.98, 11.60, 12.23, 12.85, 13.47, 14.10, 14.72, 15.34, 15.96, 16.58, 17.20, 17.82, 18.44, 19.06, 19.67, 20.29, 20.90, 21.52, 22.13, 22.74, 23.36, 23.97, 24.58, 25.19, 25.79, 26.40, 27.01, 27.61, 28.21, 28.82, 29.42, 30.02, 30.62, 31.22, 31.81, 32.41, 33.00, 33.59, 34.19, 34.78, 35.36, 35.95, 36.54, 37.12, 37.71, 38.29, 38.87, 39.44, 40.02, 40.60, 41.17, 41.74, 42.31, 42.88, 43.45, 44.01, 44.58, 45.14, 45.70, 46.26, 46.81, 47.37, 47.92, 48.47, 49.02, 49.57, 50.11, 50.66, 51.20, 51.74, 52.27, 52.81, 53.34, 53.87, 54.40, 54.93, 55.45, 55.97, 56.49, 57.01, 57.53, 58.04, 58.55, 59.06, 59.56, 60.07, 60.57, 61.07, 61.56, 62.06, 62.55, 63.04, 63.53, 64.01, 64.49, 64.97, 65.45, 65.92, 66.39, 66.86, 67.33, 67.79, 68.25, 68.71, 69.17, 69.62, 70.07, 70.52, 70.96, 71.40, 71.84, 72.28, 72.71, 73.14, 73.57, 73.99, 74.41, 74.83, 75.25, 75.66, 76.07, 76.48, 76.88, 77.28, 77.68, 78.07, 78.46, 78.85, 79.24, 79.62, 80.00, 80.37, 80.74, 81.11, 81.48, 81.84, 82.20, 82.56, 82.91, 83.26, 83.61, 83.95, 84.29, 84.63, 84.96, 85.29, 85.62, 85.94, 86.26, 86.58, 86.89, 87.20, 87.50, 87.81, 88.11, 88.40, 88.69, 88.98, 89.27, 89.55, 89.83, 90.10, 90.37, 90.64, 90.90, 91.16, 91.42, 91.67, 91.92, 92.17, 92.41, 92.65, 92.88, 93.11, 93.34, 93.57, 93.79, 94.00, 94.21, 94.42, 94.63, 94.83, 95.03, 95.22, 95.41, 95.60, 95.78, 95.96, 96.13, 96.31, 96.47, 96.64, 96.80, 96.95, 97.10, 97.25, 97.40, 97.54, 97.67, 97.81, 97.94, 98.06, 98.18, 98.30, 98.41, 98.52, 98.63, 98.73, 98.83, 98.92, 99.01, 99.10, 99.18, 99.26, 99.33, 99.40, 99.47, 99.53, 99.59, 99.65, 99.70, 99.74, 99.79, 99.83, 99.86, 99.89, 99.92, 99.94, 99.96, 99.98, 99.99, 100.00, 100.00, 100.00, 99.99, 99.99, 99.97, 99.96, 99.94, 99.91, 99.89, 99.85, 99.82, 99.78, 99.73, 99.69, 99.63, 99.58, 99.52, 99.45, 99.39, 99.32, 99.24, 99.16, 99.08, 98.99, 98.90, 98.80, 98.71, 98.60, 98.50, 98.39, 98.27, 98.15, 98.03, 97.90, 97.77, 97.64, 97.50, 97.36, 97.22, 97.07, 96.91, 96.76, 96.60, 96.43, 96.26, 96.09, 95.92, 95.74, 95.55, 95.36, 95.17, 94.98, 94.78, 94.58, 94.37, 94.16, 93.95, 93.73, 93.51, 93.29, 93.06, 92.83, 92.59, 92.35, 92.11, 91.86, 91.61, 91.36, 91.10, 90.84, 90.57, 90.31, 90.03, 89.76, 89.48, 89.20, 88.91, 88.62, 88.33, 88.03, 87.73, 87.43, 87.12, 86.81, 86.50, 86.18, 85.86, 85.54, 85.21, 84.88, 84.54, 84.21, 83.87, 83.52, 83.17, 82.82, 82.47, 82.11, 81.75, 81.39, 81.02, 80.65, 80.28, 79.90, 79.52, 79.14, 78.75, 78.36, 77.97, 77.58, 77.18, 76.78, 76.37, 75.97, 75.56, 75.14, 74.73, 74.31, 73.89, 73.46, 73.03, 72.60, 72.17, 71.73, 71.29, 70.85, 70.40, 69.96, 69.51, 69.05, 68.60, 68.14, 67.68, 67.21, 66.75, 66.28, 65.80, 65.33, 64.85, 64.37, 63.89, 63.41, 62.92, 62.43, 61.94, 61.44, 60.94, 60.44, 59.94, 59.44, 58.93, 58.42, 57.91, 57.40, 56.88, 56.36, 55.84, 55.32, 54.80, 54.27, 53.74, 53.21, 52.67, 52.14, 51.60, 51.06, 50.52, 49.98, 49.43, 48.88, 48.34, 47.78, 47.23, 46.68, 46.12, 45.56, 45.00, 44.44, 43.87, 43.31, 42.74, 42.17, 41.60, 41.03, 40.45, 39.88, 39.30, 38.72, 38.14, 37.56, 36.98, 36.39, 35.81, 35.22, 34.63, 34.04, 33.45, 32.85, 32.26, 31.66, 31.07, 30.47, 29.87, 29.27, 28.67, 28.06, 27.46, 26.85, 26.25, 25.64, 25.03, 24.42, 23.81, 23.20, 22.59, 21.98, 21.36, 20.75, 20.13, 19.52, 18.90, 18.28, 17.67, 17.05, 16.43, 15.81, 15.19, 14.56, 13.94, 13.32, 12.70, 12.07, 11.45, 10.82, 10.20, 9.57, 8.95, 8.32, 7.69, 7.07, 6.44, 5.81, 5.18, 4.56, 3.93, 3.30, 2.67, 2.04, 1.41, 0.79, 0.16, -0.47, -1.10, -1.73, -2.36, -2.99, -3.61, -4.24, -4.87, -5.50, -6.13, -6.75, -7.38, -8.01, -8.63, -9.26, -9.88, -10.51, -11.14, -11.76, -12.38, -13.01, -13.63, -14.25, -14.87, -15.50, -16.12, -16.74, -17.36, -17.97, -18.59, -19.21, -19.83, -20.44, -21.06, -21.67, -22.28, -22.90, -23.51, -24.12, -24.73, -25.34, -25.95, -26.55, -27.16, -27.76, -28.37, -28.97, -29.57, -30.17, -30.77, -31.36, -31.96, -32.56, -33.15, -33.74, -34.33, -34.92, -35.51, -36.10, -36.68, -37.27, -37.85, -38.43, -39.01, -39.59, -40.17, -40.74, -41.31, -41.89, -42.46, -43.02, -43.59, -44.16, -44.72, -45.28, -45.84, -46.40, -46.95, -47.51, -48.06, -48.61, -49.16, -49.70, -50.25, -50.79, -51.33, -51.87, -52.41, -52.94, -53.47, -54.00, -54.53, -55.06, -55.58, -56.10, -56.62, -57.14, -57.65, -58.17, -58.68, -59.18, -59.69, -60.19, -60.69, -61.19, -61.69, -62.18, -62.67, -63.16, -63.65, -64.13, -64.61, -65.09, -65.57, -66.04, -66.51, -66.98, -67.44, -67.91, -68.37, -68.83, -69.28, -69.73, -70.18, -70.63, -71.07, -71.51, -71.95, -72.38, -72.82, -73.25, -73.67, -74.10, -74.52, -74.94, -75.35, -75.76, -76.17, -76.58, -76.98, -77.38, -77.78, -78.17, -78.56, -78.95, -79.33, -79.71, -80.09, -80.47, -80.84, -81.21, -81.57, -81.93, -82.29, -82.65, -83.00, -83.35, -83.69, -84.04, -84.38, -84.71, -85.04, -85.37, -85.70, -86.02, -86.34, -86.65, -86.97, -87.28, -87.58, -87.88, -88.18, -88.48, -88.77, -89.05, -89.34, -89.62, -89.90, -90.17, -90.44, -90.71, -90.97, -91.23, -91.48, -91.74, -91.98, -92.23, -92.47, -92.71, -92.94, -93.17, -93.40, -93.62, -93.84, -94.06, -94.27, -94.48, -94.68, -94.88, -95.08, -95.27, -95.46, -95.64, -95.83, -96.00, -96.18, -96.35, -96.51, -96.68, -96.84, -96.99, -97.14, -97.29, -97.43, -97.57, -97.71, -97.84, -97.97, -98.09, -98.21, -98.33, -98.44, -98.55, -98.65, -98.76, -98.85, -98.95, -99.03, -99.12, -99.20, -99.28, -99.35, -99.42, -99.49, -99.55, -99.61, -99.66, -99.71, -99.76, -99.80, -99.84, -99.87, -99.90, -99.93, -99.95, -99.97, -99.98, -99.99, -100.00, -100.00, -100.00, -99.99, -99.98, -99.97, -99.95, -99.93, -99.91, -99.88, -99.84, -99.81, -99.77, -99.72, -99.67, -99.62, -99.56, -99.50, -99.44, -99.37, -99.30, -99.22, -99.14, -99.06, -98.97, -98.88, -98.78, -98.68, -98.58, -98.47, -98.36, -98.24, -98.12, -98.00, -97.87, -97.74, -97.61, -97.47, -97.33, -97.18, -97.03, -96.87, -96.72, -96.56, -96.39, -96.22, -96.05, -95.87, -95.69, -95.51, -95.32, -95.13, -94.93, -94.73, -94.53, -94.32, -94.11, -93.89, -93.68, -93.45, -93.23, -93.00, -92.77, -92.53, -92.29, -92.05, -91.80, -91.55, -91.29, -91.03, -90.77, -90.51, -90.24, -89.96, -89.69, -89.41, -89.13, -88.84, -88.55, -88.25, -87.96, -87.66, -87.35, -87.04, -86.73, -86.42, -86.10, -85.78, -85.45, -85.13, -84.79, -84.46, -84.12, -83.78, -83.44, -83.09, -82.74, -82.38, -82.02, -81.66, -81.30, -80.93, -80.56, -80.18, -79.81, -79.43, -79.04, -78.66, -78.27, -77.87, -77.48, -77.08, -76.68, -76.27, -75.86, -75.45, -75.04, -74.62, -74.20, -73.78, -73.35, -72.92, -72.49, -72.06, -71.62, -71.18, -70.74, -70.29, -69.84, -69.39, -68.94, -68.48, -68.02, -67.56, -67.10, -66.63, -66.16, -65.69, -65.21, -64.73, -64.25, -63.77, -63.28, -62.80, -62.31, -61.81, -61.32, -60.82, -60.32, -59.82, -59.31, -58.80, -58.29, -57.78, -57.27, -56.75, -56.23, -55.71, -55.19, -54.66, -54.14, -53.61, -53.07, -52.54, -52.01, -51.47, -50.93, -50.39, -49.84, -49.30, -48.75, -48.20, -47.65, -47.09, -46.54, -45.98, -45.42, -44.86, -44.30, -43.73, -43.17, -42.60, -42.03, -41.46, -40.88, -40.31, -39.73, -39.16, -38.58, -38.00, -37.41, -36.83, -36.24, -35.66, -35.07, -34.48, -33.89, -33.30, -32.70, -32.11, -31.51, -30.92, -30.32, -29.72, -29.12, -28.52, -27.91, -27.31, -26.70, -26.10, -25.49, -24.88, -24.27, -23.66, -23.05, -22.44, -21.83, -21.21, -20.60, -19.98, -19.36, -18.75, -18.13, -17.51, -16.89, -16.27, -15.65, -15.03, -14.41, -13.79, -13.16, -12.54, -11.92, -11.29, -10.67, -10.04, -9.42, -8.79, -8.16, -7.54, -6.91, -6.28, -5.65, -5.03, -4.40, -3.77, -3.14, -2.51, -1.89, -1.26, -0.63, -0.00
// };

// static const float spLUT[6] = {
//     50.0, 150.0, 100.0, -50.0, -100.0, 100.0 
// };

static const float sinLUT[1500] = {
    0.00, 2.10, 4.19, 6.29, 8.38, 10.48, 12.57, 14.66, 16.75, 18.84, 20.93, 23.02, 25.11, 27.19, 29.27, 31.35, 33.43, 35.51, 37.58, 39.65, 41.72, 43.78, 45.85, 47.91, 49.96, 52.01, 54.06, 56.10, 58.14, 60.18, 62.21, 64.24, 66.26, 68.28, 70.30, 72.30, 74.31, 76.31, 78.30, 80.29, 82.27, 84.25, 86.22, 88.18, 90.14, 92.09, 94.03, 95.97, 97.91, 99.83, 101.75, 103.66, 105.56, 107.46, 109.35, 111.23, 113.10, 114.97, 116.82, 118.67, 120.51, 122.34, 124.17, 125.98, 127.79, 129.58, 131.37, 133.15, 134.92, 136.68, 138.43, 140.17, 141.90, 143.62, 145.33, 147.03, 148.72, 150.40, 152.07, 153.73, 155.37, 157.01, 158.64, 160.25, 161.85, 163.45, 165.03, 166.59, 168.15, 169.70, 171.23, 172.75, 174.26, 175.75, 177.24, 178.71, 180.17, 181.62, 183.05, 184.47, 185.88, 187.27, 188.66, 190.02, 191.38, 192.72, 194.05, 195.36, 196.67, 197.95, 199.23, 200.48, 201.73, 202.96, 204.18, 205.38, 206.57, 207.74, 208.90, 210.04, 211.17, 212.29, 213.39, 214.47, 215.54, 216.59, 217.63, 218.66, 219.66, 220.66, 221.63, 222.60, 223.54, 224.47, 225.39, 226.29, 227.17, 228.04, 228.89, 229.72, 230.54, 231.34, 232.13, 232.90, 233.65, 234.39, 235.11, 235.82, 236.50, 237.17, 237.83, 238.47, 239.09, 239.69, 240.28, 240.85, 241.40, 241.94, 242.46, 242.96, 243.45, 243.91, 244.36, 244.80, 245.22, 245.61, 246.00, 246.36, 246.71, 247.04, 247.35, 247.65, 247.93, 248.19, 248.43, 248.66, 248.86, 249.06, 249.23, 249.38, 249.52, 249.64, 249.75, 249.83, 249.90, 249.95, 249.98, 250.00, 250.00, 249.98, 249.94, 249.88, 249.81, 249.72, 249.61, 249.49, 249.35, 249.19, 249.01, 248.81, 248.60, 248.37, 248.12, 247.86, 247.58, 247.28, 246.96, 246.62, 246.27, 245.90, 245.52, 245.11, 244.69, 244.25, 243.80, 243.33, 242.84, 242.33, 241.81, 241.27, 240.71, 240.13, 239.54, 238.93, 238.31, 237.67, 237.01, 236.33, 235.64, 234.93, 234.21, 233.47, 232.71, 231.94, 231.14, 230.34, 229.52, 228.68, 227.82, 226.95, 226.06, 225.16, 224.24, 223.31, 222.36, 221.39, 220.41, 219.41, 218.40, 217.37, 216.33, 215.27, 214.20, 213.11, 212.01, 210.89, 209.76, 208.61, 207.45, 206.27, 205.08, 203.87, 202.65, 201.42, 200.17, 198.91, 197.63, 196.34, 195.04, 193.72, 192.39, 191.04, 189.68, 188.31, 186.93, 185.53, 184.12, 182.69, 181.26, 179.81, 178.34, 176.87, 175.38, 173.88, 172.37, 170.85, 169.31, 167.76, 166.20, 164.63, 163.05, 161.45, 159.85, 158.23, 156.60, 154.96, 153.31, 151.65, 149.98, 148.30, 146.61, 144.90, 143.19, 141.47, 139.74, 137.99, 136.24, 134.48, 132.71, 130.93, 129.14, 127.34, 125.53, 123.71, 121.89, 120.05, 118.21, 116.36, 114.50, 112.63, 110.76, 108.88, 106.98, 105.09, 103.18, 101.27, 99.35, 97.42, 95.49, 93.55, 91.60, 89.65, 87.69, 85.72, 83.75, 81.77, 79.79, 77.80, 75.81, 73.81, 71.80, 69.79, 67.78, 65.76, 63.73, 61.71, 59.67, 57.64, 55.59, 53.55, 51.50, 49.45, 47.39, 45.33, 43.27, 41.20, 39.13, 37.06, 34.99, 32.91, 30.83, 28.75, 26.67, 24.59, 22.50, 20.41, 18.32, 16.23, 14.14, 12.05, 9.95, 7.86, 5.76, 3.67, 1.57, -0.52, -2.62, -4.72, -6.81, -8.91, -11.00, -13.09, -15.19, -17.28, -19.37, -21.46, -23.54, -25.63, -27.71, -29.79, -31.87, -33.95, -36.03, -38.10, -40.17, -42.24, -44.30, -46.36, -48.42, -50.47, -52.52, -54.57, -56.61, -58.65, -60.69, -62.72, -64.75, -66.77, -68.79, -70.80, -72.81, -74.81, -76.81, -78.80, -80.78, -82.76, -84.74, -86.71, -88.67, -90.63, -92.58, -94.52, -96.46, -98.39, -100.31, -102.23, -104.14, -106.04, -107.93, -109.82, -111.70, -113.57, -115.43, -117.29, -119.13, -120.97, -122.80, -124.62, -126.43, -128.24, -130.03, -131.82, -133.59, -135.36, -137.12, -138.87, -140.60, -142.33, -144.05, -145.76, -147.45, -149.14, -150.82, -152.48, -154.14, -155.78, -157.42, -159.04, -160.65, -162.25, -163.84, -165.42, -166.98, -168.54, -170.08, -171.61, -173.13, -174.63, -176.13, -177.61, -179.08, -180.53, -181.98, -183.41, -184.82, -186.23, -187.62, -189.00, -190.36, -191.72, -193.06, -194.38, -195.69, -196.99, -198.27, -199.54, -200.80, -202.04, -203.27, -204.48, -205.68, -206.86, -208.03, -209.19, -210.33, -211.45, -212.56, -213.66, -214.74, -215.80, -216.85, -217.89, -218.91, -219.91, -220.90, -221.88, -222.83, -223.78, -224.70, -225.61, -226.51, -227.39, -228.25, -229.10, -229.93, -230.74, -231.54, -232.32, -233.09, -233.84, -234.57, -235.29, -235.99, -236.67, -237.34, -237.99, -238.62, -239.24, -239.84, -240.42, -240.99, -241.54, -242.07, -242.59, -243.08, -243.56, -244.03, -244.47, -244.90, -245.32, -245.71, -246.09, -246.45, -246.79, -247.12, -247.43, -247.72, -247.99, -248.25, -248.49, -248.71, -248.91, -249.10, -249.27, -249.42, -249.55, -249.67, -249.77, -249.85, -249.91, -249.96, -249.99, -250.00, -249.99, -249.97, -249.93, -249.87, -249.79, -249.70, -249.58, -249.46, -249.31, -249.14, -248.96, -248.76, -248.55, -248.31, -248.06, -247.79, -247.50, -247.20, -246.88, -246.54, -246.18, -245.81, -245.42, -245.01, -244.58, -244.14, -243.68, -243.21, -242.71, -242.20, -241.67, -241.13, -240.57, -239.99, -239.39, -238.78, -238.15, -237.50, -236.84, -236.16, -235.47, -234.75, -234.02, -233.28, -232.52, -231.74, -230.94, -230.13, -229.31, -228.46, -227.61, -226.73, -225.84, -224.93, -224.01, -223.07, -222.12, -221.15, -220.16, -219.16, -218.15, -217.12, -216.07, -215.01, -213.93, -212.84, -211.73, -210.61, -209.47, -208.32, -207.16, -205.97, -204.78, -203.57, -202.35, -201.11, -199.86, -198.59, -197.31, -196.02, -194.71, -193.39, -192.05, -190.70, -189.34, -187.97, -186.58, -185.18, -183.76, -182.34, -180.90, -179.44, -177.98, -176.50, -175.01, -173.51, -171.99, -170.46, -168.92, -167.37, -165.81, -164.24, -162.65, -161.05, -159.44, -157.82, -156.19, -154.55, -152.90, -151.24, -149.56, -147.88, -146.18, -144.48, -142.76, -141.04, -139.30, -137.56, -135.80, -134.04, -132.26, -130.48, -128.69, -126.89, -125.08, -123.26, -121.43, -119.59, -117.75, -115.90, -114.03, -112.17, -110.29, -108.40, -106.51, -104.61, -102.70, -100.79, -98.87, -96.94, -95.00, -93.06, -91.11, -89.16, -87.20, -85.23, -83.26, -81.28, -79.29, -77.30, -75.31, -73.31, -71.30, -69.29, -67.27, -65.25, -63.23, -61.20, -59.16, -57.13, -55.08, -53.04, -50.99, -48.93, -46.88, -44.82, -42.75, -40.69, -38.62, -36.54, -34.47, -32.39, -30.31, -28.23, -26.15, -24.06, -21.98, -19.89, -17.80, -15.71, -13.62, -11.52, -9.43, -7.33, -5.24, -3.14, -1.05, 1.05, 3.14, 5.24, 7.33, 9.43, 11.52, 13.62, 15.71, 17.80, 19.89, 21.98, 24.06, 26.15, 28.23, 30.31, 32.39, 34.47, 36.54, 38.62, 40.69, 42.75, 44.82, 46.88, 48.93, 50.99, 53.04, 55.08, 57.13, 59.16, 61.20, 63.23, 65.25, 67.27, 69.29, 71.30, 73.31, 75.31, 77.30, 79.29, 81.28, 83.26, 85.23, 87.20, 89.16, 91.11, 93.06, 95.00, 96.94, 98.87, 100.79, 102.70, 104.61, 106.51, 108.40, 110.29, 112.17, 114.03, 115.90, 117.75, 119.59, 121.43, 123.26, 125.08, 126.89, 128.69, 130.48, 132.26, 134.04, 135.80, 137.56, 139.30, 141.04, 142.76, 144.48, 146.18, 147.88, 149.56, 151.24, 152.90, 154.55, 156.19, 157.82, 159.44, 161.05, 162.65, 164.24, 165.81, 167.37, 168.92, 170.46, 171.99, 173.51, 175.01, 176.50, 177.98, 179.44, 180.90, 182.34, 183.76, 185.18, 186.58, 187.97, 189.34, 190.70, 192.05, 193.39, 194.71, 196.02, 197.31, 198.59, 199.86, 201.11, 202.35, 203.57, 204.78, 205.97, 207.16, 208.32, 209.47, 210.61, 211.73, 212.84, 213.93, 215.01, 216.07, 217.12, 218.15, 219.16, 220.16, 221.15, 222.12, 223.07, 224.01, 224.93, 225.84, 226.73, 227.61, 228.46, 229.31, 230.13, 230.94, 231.74, 232.52, 233.28, 234.02, 234.75, 235.47, 236.16, 236.84, 237.50, 238.15, 238.78, 239.39, 239.99, 240.57, 241.13, 241.67, 242.20, 242.71, 243.21, 243.68, 244.14, 244.58, 245.01, 245.42, 245.81, 246.18, 246.54, 246.88, 247.20, 247.50, 247.79, 248.06, 248.31, 248.55, 248.76, 248.96, 249.14, 249.31, 249.46, 249.58, 249.70, 249.79, 249.87, 249.93, 249.97, 249.99, 250.00, 249.99, 249.96, 249.91, 249.85, 249.77, 249.67, 249.55, 249.42, 249.27, 249.10, 248.91, 248.71, 248.49, 248.25, 247.99, 247.72, 247.43, 247.12, 246.79, 246.45, 246.09, 245.71, 245.32, 244.90, 244.47, 244.03, 243.56, 243.08, 242.59, 242.07, 241.54, 240.99, 240.42, 239.84, 239.24, 238.62, 237.99, 237.34, 236.67, 235.99, 235.29, 234.57, 233.84, 233.09, 232.32, 231.54, 230.74, 229.93, 229.10, 228.25, 227.39, 226.51, 225.61, 224.70, 223.78, 222.83, 221.88, 220.90, 219.91, 218.91, 217.89, 216.85, 215.80, 214.74, 213.66, 212.56, 211.45, 210.33, 209.19, 208.03, 206.86, 205.68, 204.48, 203.27, 202.04, 200.80, 199.54, 198.27, 196.99, 195.69, 194.38, 193.06, 191.72, 190.36, 189.00, 187.62, 186.23, 184.82, 183.41, 181.98, 180.53, 179.08, 177.61, 176.13, 174.63, 173.13, 171.61, 170.08, 168.54, 166.98, 165.42, 163.84, 162.25, 160.65, 159.04, 157.42, 155.78, 154.14, 152.48, 150.82, 149.14, 147.45, 145.76, 144.05, 142.33, 140.60, 138.87, 137.12, 135.36, 133.59, 131.82, 130.03, 128.24, 126.43, 124.62, 122.80, 120.97, 119.13, 117.29, 115.43, 113.57, 111.70, 109.82, 107.93, 106.04, 104.14, 102.23, 100.31, 98.39, 96.46, 94.52, 92.58, 90.63, 88.67, 86.71, 84.74, 82.76, 80.78, 78.80, 76.81, 74.81, 72.81, 70.80, 68.79, 66.77, 64.75, 62.72, 60.69, 58.65, 56.61, 54.57, 52.52, 50.47, 48.42, 46.36, 44.30, 42.24, 40.17, 38.10, 36.03, 33.95, 31.87, 29.79, 27.71, 25.63, 23.54, 21.46, 19.37, 17.28, 15.19, 13.09, 11.00, 8.91, 6.81, 4.72, 2.62, 0.52, -1.57, -3.67, -5.76, -7.86, -9.95, -12.05, -14.14, -16.23, -18.32, -20.41, -22.50, -24.59, -26.67, -28.75, -30.83, -32.91, -34.99, -37.06, -39.13, -41.20, -43.27, -45.33, -47.39, -49.45, -51.50, -53.55, -55.59, -57.64, -59.67, -61.71, -63.73, -65.76, -67.78, -69.79, -71.80, -73.81, -75.81, -77.80, -79.79, -81.77, -83.75, -85.72, -87.69, -89.65, -91.60, -93.55, -95.49, -97.42, -99.35, -101.27, -103.18, -105.09, -106.98, -108.88, -110.76, -112.63, -114.50, -116.36, -118.21, -120.05, -121.89, -123.71, -125.53, -127.34, -129.14, -130.93, -132.71, -134.48, -136.24, -137.99, -139.74, -141.47, -143.19, -144.90, -146.61, -148.30, -149.98, -151.65, -153.31, -154.96, -156.60, -158.23, -159.85, -161.45, -163.05, -164.63, -166.20, -167.76, -169.31, -170.85, -172.37, -173.88, -175.38, -176.87, -178.34, -179.81, -181.26, -182.69, -184.12, -185.53, -186.93, -188.31, -189.68, -191.04, -192.39, -193.72, -195.04, -196.34, -197.63, -198.91, -200.17, -201.42, -202.65, -203.87, -205.08, -206.27, -207.45, -208.61, -209.76, -210.89, -212.01, -213.11, -214.20, -215.27, -216.33, -217.37, -218.40, -219.41, -220.41, -221.39, -222.36, -223.31, -224.24, -225.16, -226.06, -226.95, -227.82, -228.68, -229.52, -230.34, -231.14, -231.94, -232.71, -233.47, -234.21, -234.93, -235.64, -236.33, -237.01, -237.67, -238.31, -238.93, -239.54, -240.13, -240.71, -241.27, -241.81, -242.33, -242.84, -243.33, -243.80, -244.25, -244.69, -245.11, -245.52, -245.90, -246.27, -246.62, -246.96, -247.28, -247.58, -247.86, -248.12, -248.37, -248.60, -248.81, -249.01, -249.19, -249.35, -249.49, -249.61, -249.72, -249.81, -249.88, -249.94, -249.98, -250.00, -250.00, -249.98, -249.95, -249.90, -249.83, -249.75, -249.64, -249.52, -249.38, -249.23, -249.06, -248.86, -248.66, -248.43, -248.19, -247.93, -247.65, -247.35, -247.04, -246.71, -246.36, -246.00, -245.61, -245.22, -244.80, -244.36, -243.91, -243.45, -242.96, -242.46, -241.94, -241.40, -240.85, -240.28, -239.69, -239.09, -238.47, -237.83, -237.17, -236.50, -235.82, -235.11, -234.39, -233.65, -232.90, -232.13, -231.34, -230.54, -229.72, -228.89, -228.04, -227.17, -226.29, -225.39, -224.47, -223.54, -222.60, -221.63, -220.66, -219.66, -218.66, -217.63, -216.59, -215.54, -214.47, -213.39, -212.29, -211.17, -210.04, -208.90, -207.74, -206.57, -205.38, -204.18, -202.96, -201.73, -200.48, -199.23, -197.95, -196.67, -195.36, -194.05, -192.72, -191.38, -190.02, -188.66, -187.27, -185.88, -184.47, -183.05, -181.62, -180.17, -178.71, -177.24, -175.75, -174.26, -172.75, -171.23, -169.70, -168.15, -166.59, -165.03, -163.45, -161.85, -160.25, -158.64, -157.01, -155.37, -153.73, -152.07, -150.40, -148.72, -147.03, -145.33, -143.62, -141.90, -140.17, -138.43, -136.68, -134.92, -133.15, -131.37, -129.58, -127.79, -125.98, -124.17, -122.34, -120.51, -118.67, -116.82, -114.97, -113.10, -111.23, -109.35, -107.46, -105.56, -103.66, -101.75, -99.83, -97.91, -95.97, -94.03, -92.09, -90.14, -88.18, -86.22, -84.25, -82.27, -80.29, -78.30, -76.31, -74.31, -72.30, -70.30, -68.28, -66.26, -64.24, -62.21, -60.18, -58.14, -56.10, -54.06, -52.01, -49.96, -47.91, -45.85, -43.78, -41.72, -39.65, -37.58, -35.51, -33.43, -31.35, -29.27, -27.19, -25.11, -23.02, -20.93, -18.84, -16.75, -14.66, -12.57, -10.48, -8.38, -6.29, -4.19, -2.10, -0.00    
};

static uint32_t sp_iter = 0;

#define LOC_TIME_1 8000
#define LOC_TIME_2 16000
#define LOC_TIME_3 24000

static float my_posis[12000];
static uint32_t my_posis_cnt;
static uint32_t my_posis_cnt2;

void App_Motor_Task(void)
{
    static uint32_t local_time = 0;
    static const uint32_t state_times[2U] = {APP_MOTOR_ALIGNMENT_TIME, APP_MOTOR_START_TIME};
    float cur_pos;

    local_time++;

#if (APP_MOTOR_DYNAMIC == APP_MOTOR_DISABLED)
    if(1U == local_time)
    {
        App_Motor_SpeedSetpoint = APP_MOTOR_SPEED_START;
        App_Motor_PositionSetpoint = APP_MOTOR_POSITION_START;
    }
#endif

   #if (APP_MOTOR_STARTUP == APP_MOTOR_DISABLED)
   if(App_Motor_Setup.motor_state != APP_MOTOR_MOTOR_STOP)
   {
        App_Motor_Setup.motor_state = APP_MOTOR_MOTOR_RUN;
   }
   #endif

    switch (App_Motor_Setup.motor_state)
    {
        case APP_MOTOR_MOTOR_ALIGNMENT:
            App_Motor_StateAlignment();
            break;
        case APP_MOTOR_MOTOR_START:

            #if (APP_MOTOR_DYNAMIC == APP_MOTOR_ENABLED)
                // if((local_time % 10) == 0)
                // {
                //     if(sp_iter < 2000)
                //     {
                //         App_Motor_SpeedSetpoint = sinLUT[sp_iter];
                //         sp_iter++;
                //     }
                // }

                // if((local_time % 5000) == 0)
                // {
                //     if(sp_iter < 6)
                //     {
                //         App_Motor_SpeedSetpoint = spLUT[sp_iter];
                //         sp_iter++;
                //     }
                // }

// zmiana nastaw? + wł/wył orzy osiagnieciu pozycji

                // cur_pos = App_Enc_GetAngle();

                // if((local_time == LOC_TIME_1) ||
                //    (local_time == LOC_TIME_2))
                // {
                //     App_Pid_Reset(&App_Motor_Setup.pid_speed);
                //     App_Pid_Reset(&App_Motor_Setup.pid_position);
                //     App_6step_Enable();
                // }

                // if(local_time < LOC_TIME_1)
                // {
                //     App_Motor_PositionSetpoint = 100.0f;

                //     if(cur_pos > (App_Motor_PositionSetpoint - 0.2f))
                //     {
                //         App_6step_Disable();
                //     }
                // }
                // else if (local_time < LOC_TIME_2)
                // {
                //     App_Motor_PositionSetpoint = 250.0f;

                //     if(cur_pos > (App_Motor_PositionSetpoint - 0.2f))
                //     {
                //         App_6step_Disable();
                //     }
                // }
                // else if (local_time < LOC_TIME_3)
                // {
                //     App_Motor_PositionSetpoint = 0.0f;

                //     if(cur_pos < (App_Motor_PositionSetpoint + 0.2f))
                //     {
                //         App_6step_Disable();
                //     }
                // }      

                if((local_time % 20) == 0)
                {
                    if(sp_iter < 1500)
                    {
                        App_Motor_PositionSetpoint = sinLUT[sp_iter];
                        sp_iter++;
                    }
                }

            #endif

            App_Motor_StateStart();
            break;
        case APP_MOTOR_MOTOR_RUN:
           #if (APP_MOTOR_BEMF_ANALYSIS == APP_MOTOR_ENABLED)
            App_Motor_Setup.bldc_state = APP_MOTOR_BLDC_ENABLED;
           #endif

           #if (APP_MOTOR_CURRENT_ANALYSIS == APP_MOTOR_ENABLED)
            App_Motor_Setup.current_state = APP_MOTOR_BLDC_ENABLED;
           #endif
            break;
        default:
            break;
    }

    if(App_Motor_Setup.motor_state < APP_MOTOR_MOTOR_RUN)
    {
        if(local_time >= state_times[App_Motor_Setup.motor_state])
        {
            App_Motor_Setup.motor_state++;
        }
    }

    float c_pos = App_Enc_GetAngle();
    float c_speed = App_Motor_GetSpeed();

    if(APP_6STEP_DIR_CLOCKWISE == App_6step_GetDir())
    {
        c_speed = -c_speed;
    }

// potencjalnie enkoder wysyła 1/0 zamist sin i cos - spwrawdzic c o nie gra

    if((local_time % 2) == 0)
    {
        // if(my_posis_cnt < 11000)
        // {
        //     my_posis[my_posis_cnt] = c_pos;
        //     my_posis_cnt++;
        // }

        // 1 - current position
        char *tmpSign = (c_pos < 0) ? "-" : "";
        float tmpVal = (c_pos < 0) ? -c_pos : c_pos;

        int tmpInt1 = tmpVal;                  // Get the integer (678).
        float tmpFrac = tmpVal - tmpInt1;      // Get fraction (0.0123).
        int tmpInt2 = trunc(tmpFrac * 100);  // Turn into integer (123).

        // sprintf (buffer, "%s%d.%02d\r\n", tmpSign, tmpInt1, tmpInt2);

        // 2 - current speed
        char *tmpSign_2 = (c_speed < 0) ? "-" : "";
        float tmpVal_2 = (c_speed < 0) ? -c_speed : c_speed;

        int tmpInt1_2 = tmpVal_2;                  // Get the integer (678).
        float tmpFrac_2 = tmpVal_2 - tmpInt1_2;      // Get fraction (0.0123).
        int tmpInt2_2 = trunc(tmpFrac_2 * 100);  // Turn into integer (123).

        // sprintf (buffer, "%s%d.%02d %s%d.%02d\r\n", tmpSign, tmpInt1, tmpInt2, tmpSign_2, tmpInt1_2, tmpInt2_2);

        // 3 - speed setpoint
        char *tmpSign_3 = (App_Motor_SpeedSetpoint < 0) ? "-" : "";
        float tmpVal_3 = (App_Motor_SpeedSetpoint < 0) ? -App_Motor_SpeedSetpoint : App_Motor_SpeedSetpoint;

        int tmpInt1_3 = tmpVal_3;                  // Get the integer (678).
        float tmpFrac_3 = tmpVal_3 - tmpInt1_3;      // Get fraction (0.0123).
        int tmpInt2_3 = trunc(tmpFrac_3 * 100);  // Turn into integer (123).

        // sprintf (buffer, "%s%d.%02d %s%d.%02d %s%d.%02d\r\n", tmpSign, tmpInt1, tmpInt2, tmpSign_2, tmpInt1_2, tmpInt2_2, tmpSign_3, tmpInt1_3, tmpInt2_3);


        // 4 - position setpoint
        char *tmpSign_4 = (App_Motor_PositionSetpoint < 0) ? "-" : "";
        float tmpVal_4 = (App_Motor_PositionSetpoint < 0) ? -App_Motor_PositionSetpoint : App_Motor_PositionSetpoint;

        int tmpInt1_4 = tmpVal_4;                  // Get the integer (678).
        float tmpFrac_4 = tmpVal_4 - tmpInt1_4;      // Get fraction (0.0123).
        int tmpInt2_4 = trunc(tmpFrac_3 * 100);  // Turn into integer (123).


        sprintf (buffer, "%s%d.%02d %s%d.%02d %s%d.%02d %s%d.%02d\r\n", tmpSign, tmpInt1, tmpInt2, tmpSign_2, tmpInt1_2, tmpInt2_2, tmpSign_3, tmpInt1_3, tmpInt2_3, tmpSign_4, tmpInt1_4, tmpInt2_4);

        // Print as parts, note that you need 0-padding for fractional bit.
        UART_StartTransmitIRQ(&UART_0, (uint8_t*)buffer, (uint32_t)strlen(buffer));
    }




}

void App_Motor_Async(void)
{
    if((App_Motor_Setup.motor_state == APP_MOTOR_MOTOR_START) || 
       (App_Motor_Setup.motor_state == APP_MOTOR_MOTOR_RUN))
    {
        App_6step_AlgoIteration();
        App_Motor_Setup.step_updated_flag = 1U;
    }
}

void App_Motor_Disable(void)
{
    App_Motor_Setup.motor_state = APP_MOTOR_MOTOR_STOP;
}

void App_Motor_AdcAnalysis(void)
{
    if(APP_MOTOR_BLDC_ENABLED == App_Motor_Setup.bldc_state)
    {
        App_Motor_BemfAnalysis();
    }

    if(APP_MOTOR_BLDC_ENABLED == App_Motor_Setup.current_state)
    {
        App_Motor_CurrentAnalysis();
    }  
}

/***********************************************************************************************************
 ******************************************** Local functions **********************************************
 ***********************************************************************************************************/

static void App_Motor_StateAlignment(void)
{
    App_6step_SetStepNumber(6U);
    App_6step_AlgoIteration();
}

// static void App_Motor_StateStart(void)
// {
//     int16_t diff;
//     uint16_t new_speed;
// 	uint16_t current_speed = Hal_Tim_GetPeriodReg(HAL_TIM_TIMER_1);

// 	diff = (int16_t)App_Pid_Calculate(&App_Motor_Setup.pid_speed, APP_MOTOR_SPEED_START, current_speed);
//     new_speed =  (uint16_t)(((current_speed + diff) >= APP_MOTOR_SPEED_MAX) ? (current_speed + diff) : APP_MOTOR_SPEED_MAX);

// 	Hal_Tim_SetPeriodReg(HAL_TIM_TIMER_1, new_speed);
// }

static void App_Motor_StateStart(void)
{
    static uint32_t local_time = 0;
    float diff_speed, diff_position;
	float current_speed, current_position;

    local_time++;

#if (APP_MOTOR_PID_POSITION == APP_MOTOR_ENABLED)
    
    if((local_time % 20) == 0)
    {
        current_position = App_Enc_GetAngle();
        diff_position = App_Pid_Calculate(&App_Motor_Setup.pid_position, App_Motor_PositionSetpoint, current_position);
        App_Motor_SpeedSetpoint = diff_position;
        
        // if((current_position + 1.5f > App_Motor_PositionSetpoint))
        // {
        //     App_6step_Disable();
        //     App_Motor_Setup.motor_state = APP_MOTOR_MOTOR_STOP;
        // }
    }

    if((local_time % 5) == 0)
    {
        diff_speed = App_Pid_Calculate(&App_Motor_Setup.pid_speed, App_Motor_SpeedSetpoint, App_Motor_CurrentSpeed);
        App_Motor_CurrentSpeed = App_Motor_CurrentSpeed + diff_speed;

        if(App_Motor_CurrentSpeed >= 0)
        {
            App_6step_SetDir(APP_6STEP_DIR_COUNTERWISE);
            App_Motor_SetSpeed(App_Motor_CurrentSpeed);
        }
        else
        {
            App_6step_SetDir(APP_6STEP_DIR_CLOCKWISE);
            App_Motor_SetSpeed(-App_Motor_CurrentSpeed);
        }
    }
#else
    // current_speed = App_Motor_GetSpeed();
	// diff_speed = App_Pid_Calculate(&App_Motor_Setup.pid_speed, App_Motor_SpeedSetpoint, current_speed);
	// App_Motor_SetSpeed(current_speed + diff_speed);

    if((local_time % 5) == 0)
    {
        diff_speed = App_Pid_Calculate(&App_Motor_Setup.pid_speed, App_Motor_SpeedSetpoint, App_Motor_CurrentSpeed);
        App_Motor_CurrentSpeed = App_Motor_CurrentSpeed + diff_speed;

        if(App_Motor_CurrentSpeed >= 0)
        {
            App_6step_SetDir(APP_6STEP_DIR_COUNTERWISE);
            App_Motor_SetSpeed(App_Motor_CurrentSpeed);
        }
        else
        {
            App_6step_SetDir(APP_6STEP_DIR_CLOCKWISE);
            App_Motor_SetSpeed(-App_Motor_CurrentSpeed);
        }
    }

#endif
}

void App_Motor_BemfAnalysis(void)
{
    uint16_t bemf_filtered_val;
    bool status; 

    /* Start analysis only when step was updated */
    if(App_Motor_Setup.step_updated_flag)
    {
        /* Demagnetization */
        if(Hal_Tim_GetCunterReg(HAL_TIM_TIMER_1) >= (Hal_Tim_GetPeriodReg(HAL_TIM_TIMER_1) >> APP_MOTOR_DIV_BY_8))
        {
            switch (App_6step_GetActualStepNumber())
            {
                case 1U:
                    status = App_Motor_AddBemfToFifo(Hal_Adc_GetSingleData(HAL_ADC_INSTANCE_BEMF, APP_MOTOR_BEMF_W_PHASE), &bemf_filtered_val);
                    if(App_6step_GetDir() == APP_6STEP_DIR_CLOCKWISE)
                    {
                        if((status == true) && (bemf_filtered_val < APP_MOTOR_BEMF_THRESHOLD_DOWN))
                        {
                            App_Motor_ZeroCrossingPointDetected();
                        }
                    }
                    else
                    {
                        if((status == true) && (bemf_filtered_val > APP_MOTOR_BEMF_THRESHOLD_UP))
                        {
                            App_Motor_ZeroCrossingPointDetected();
                        }
                    }
                    break;
                case 2U:
                    status = App_Motor_AddBemfToFifo(Hal_Adc_GetSingleData(HAL_ADC_INSTANCE_BEMF, APP_MOTOR_BEMF_V_PHASE), &bemf_filtered_val);
                    if(App_6step_GetDir() == APP_6STEP_DIR_CLOCKWISE)
                    {
                        if((status == true) && (bemf_filtered_val > APP_MOTOR_BEMF_THRESHOLD_UP))
                        {
                            App_Motor_ZeroCrossingPointDetected();
                        }
                    }
                    else
                    {
                        if((status == true) && (bemf_filtered_val < APP_MOTOR_BEMF_THRESHOLD_DOWN))
                        {
                            App_Motor_ZeroCrossingPointDetected();
                        }
                    }
                    break;
                case 3U:
                    status = App_Motor_AddBemfToFifo(Hal_Adc_GetSingleData(HAL_ADC_INSTANCE_BEMF, APP_MOTOR_BEMF_U_PHASE), &bemf_filtered_val);
                    if(App_6step_GetDir() == APP_6STEP_DIR_CLOCKWISE)
                    {
                        if((status == true) && (bemf_filtered_val < APP_MOTOR_BEMF_THRESHOLD_DOWN))
                        {
                            App_Motor_ZeroCrossingPointDetected();
                        }
                    }
                    else
                    {
                        if((status == true) && (bemf_filtered_val > APP_MOTOR_BEMF_THRESHOLD_UP))
                        {
                            App_Motor_ZeroCrossingPointDetected();
                        }
                    }
                    break;
                case 4U:
                    status = App_Motor_AddBemfToFifo(Hal_Adc_GetSingleData(HAL_ADC_INSTANCE_BEMF, APP_MOTOR_BEMF_W_PHASE), &bemf_filtered_val);
                    if(App_6step_GetDir() == APP_6STEP_DIR_CLOCKWISE)
                    {
                        if((status == true) && (bemf_filtered_val > APP_MOTOR_BEMF_THRESHOLD_UP))
                        {
                            App_Motor_ZeroCrossingPointDetected();
                        }
                    }
                    else
                    {
                        if((status == true) && (bemf_filtered_val < APP_MOTOR_BEMF_THRESHOLD_DOWN))
                        {
                            App_Motor_ZeroCrossingPointDetected();
                        }
                    }
                    break;
                case 5U:
                    status = App_Motor_AddBemfToFifo(Hal_Adc_GetSingleData(HAL_ADC_INSTANCE_BEMF, APP_MOTOR_BEMF_V_PHASE), &bemf_filtered_val);
                    if(App_6step_GetDir() == APP_6STEP_DIR_CLOCKWISE)
                    {
                        if((status == true) && (bemf_filtered_val < APP_MOTOR_BEMF_THRESHOLD_DOWN))
                        {
                            App_Motor_ZeroCrossingPointDetected();
                        }
                    }
                    else
                    {
                        if((status == true) && (bemf_filtered_val > APP_MOTOR_BEMF_THRESHOLD_UP))
                        {
                            App_Motor_ZeroCrossingPointDetected();
                        }
                    }
                    break;
                case 6U:
                    status = App_Motor_AddBemfToFifo(Hal_Adc_GetSingleData(HAL_ADC_INSTANCE_BEMF, APP_MOTOR_BEMF_U_PHASE), &bemf_filtered_val);
                    if(App_6step_GetDir() == APP_6STEP_DIR_CLOCKWISE)
                    {
                        if((status == true) && (bemf_filtered_val > APP_MOTOR_BEMF_THRESHOLD_UP))
                        {
                            App_Motor_ZeroCrossingPointDetected();
                        }
                    }
                    else
                    {
                        if((status == true) && (bemf_filtered_val < APP_MOTOR_BEMF_THRESHOLD_DOWN))
                        {
                            App_Motor_ZeroCrossingPointDetected();
                        }
                    }
                    break;
                default:
                    break;
            }
        }
    }
}

static void App_Motor_CurrentAnalysis(void)
{
    static uint16_t measurements_nbr = 0U;
    static uint32_t current_sum = 0U;
    static uint8_t last_step = 0U;
    uint8_t current_step = App_6step_GetActualStepNumber();
    int16_t diff;
    uint16_t current_avg;
    uint32_t new_pwm;
    
    measurements_nbr++;

    switch (current_step)
    {
        case 1U:
            current_sum += Hal_Adc_GetSingleData(HAL_ADC_INSTANCE_CURR_SENSE, APP_MOTOR_CURR_V_PHASE);
            break;
        case 2U:
            current_sum += Hal_Adc_GetSingleData(HAL_ADC_INSTANCE_CURR_SENSE, APP_MOTOR_CURR_W_PHASE);
            break;
        case 3U:
            current_sum += Hal_Adc_GetSingleData(HAL_ADC_INSTANCE_CURR_SENSE, APP_MOTOR_CURR_W_PHASE);
            break;
        case 4U:
            current_sum += Hal_Adc_GetSingleData(HAL_ADC_INSTANCE_CURR_SENSE, APP_MOTOR_CURR_U_PHASE);
            break;
        case 5U:
            current_sum += Hal_Adc_GetSingleData(HAL_ADC_INSTANCE_CURR_SENSE, APP_MOTOR_CURR_U_PHASE);
            break;
        case 6U:
            current_sum += Hal_Adc_GetSingleData(HAL_ADC_INSTANCE_CURR_SENSE, APP_MOTOR_CURR_V_PHASE);
            break;
        default:
            break;
    }

    if(last_step != current_step)
    {
        current_avg = (uint16_t)(current_sum / measurements_nbr);
        diff = (int16_t)App_Pid_Calculate(&App_Motor_Setup.pid_current, APP_MOTOR_CURRENT_TARGET, current_avg);
        new_pwm = (current_avg + diff) * APP_MOTOR_CURRENT_SCALE_FACTOR;
        new_pwm =  (uint16_t)(((new_pwm) <= APP_MOTOR_CURRENT_PWM_MAX) ? (new_pwm) : APP_MOTOR_CURRENT_PWM_MAX);

        App_6step_SetDutyCycle(new_pwm);

        current_sum = 0;
        measurements_nbr = 0;
    }

    last_step = current_step;
}

static bool App_Motor_AddBemfToFifo(uint16_t fifo_in, uint16_t* filtered_out)
{
    bool ret_val = false;

    if(App_Motor_Setup.bemf_cnt < APP_MOTOR_BEMF_FIFO_MAX)
    {
        App_Motor_Setup.bemf_fifo[App_Motor_Setup.bemf_cnt] = fifo_in;
        App_Motor_Setup.bemf_cnt++;
    }
    else
    {
        ret_val = true;
        App_Motor_Setup.bemf_fifo[0] = App_Motor_Setup.bemf_fifo[1];
        App_Motor_Setup.bemf_fifo[1] = App_Motor_Setup.bemf_fifo[2];
        App_Motor_Setup.bemf_fifo[2] = fifo_in;
        *filtered_out = App_Motor_CalculateAvg(App_Motor_Setup.bemf_fifo[0], 
                                               App_Motor_Setup.bemf_fifo[1], 
                                               App_Motor_Setup.bemf_fifo[2]);
    }

    return ret_val;
}

static void App_Motor_ZeroCrossingPointDetected(void)
{
    int16_t diff;
    uint16_t new_speed, updated_speed;
    uint16_t current_speed = Hal_Tim_GetPeriodReg(HAL_TIM_TIMER_1);
    uint16_t zero_crossing_time = Hal_Tim_GetCunterReg(HAL_TIM_TIMER_1);
    
    updated_speed = (zero_crossing_time * APP_MOTOR_BEMF_ZCP_COEF) + (current_speed >> APP_MOTOR_DIV_BY_2);

    if(App_Motor_Setup.motor_state == APP_MOTOR_MOTOR_RUN)
    {
        diff = (int16_t)App_Pid_Calculate(&App_Motor_Setup.pid_speed, updated_speed, current_speed);
        new_speed =  (uint16_t)(((current_speed + diff) >= APP_MOTOR_SPEED_MAX) ? (current_speed + diff) : APP_MOTOR_SPEED_MAX);
        Hal_Tim_SetPeriodReg(HAL_TIM_TIMER_1, new_speed);
    }

    App_Motor_Setup.bemf_cnt = 0U;
    App_Motor_Setup.step_updated_flag = 0U;
}

/* degrees / s */
/* PER =  (144 Mhz / (Freq * PRE)) - 1  */
/* SPEED = FREQ / (720 / 360) */
static void App_Motor_SetSpeed(float deg_s)
{
    if((deg_s <= APP_MOTOR_MAX_SPEED) && (deg_s > 0.0f))
    {
        float period_reg = (APP_MOTOR_TIM_CLOCK / ((deg_s * APP_MOTOR_STEPS_TO_CYCLE_RATIO) * APP_MOTOR_TIM_PRESCALER)) - 1.0f;
        Hal_Tim_SetPeriodReg(HAL_TIM_TIMER_1, (uint16_t)period_reg);
    }
}

static float App_Motor_GetSpeed(void)
{
    uint16_t period_reg = Hal_Tim_GetPeriodReg(HAL_TIM_TIMER_1);

    return (APP_MOTOR_TIM_CLOCK / (((float)period_reg + 1.0f) * APP_MOTOR_STEPS_TO_CYCLE_RATIO * APP_MOTOR_TIM_PRESCALER));
}
